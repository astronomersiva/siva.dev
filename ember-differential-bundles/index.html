<!DOCTYPE html><html lang="en"><head><script inline src="/static/js/dark-mode.js"></script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-57141163-3"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag('js',new Date),gtag('config','UA-57141163-3')</script><link rel="apple-touch-icon" sizes="180x180" href="/static/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/static/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/static/favicons/favicon-16x16.png"><link rel="manifest" href="/static/favicons/site.webmanifest"><link rel="mask-icon" href="/static/favicons/safari-pinned-tab.svg" color="#5bbad5"><link rel="shortcut icon" href="/static/favicons/favicon.ico"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-config" content="/static/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preload" href="/static/css/styles.css" as="style"><link rel="preload" href="/static/css/github-gist.css" as="style"><link rel="preload" href="/static/css/ajanta.css" as="style"><link rel="preload" href="/static/js/intersection-lazy-loader.js" as="script"><link rel="prefetch" href="/static/audio/switch.wav" as="audio"><link rel="prefetch" href="/static/audio/tap.wav" as="audio"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Differential Serving of Assets in Ember | Sivasubramanyam A</title><meta name="theme-color" content="#f0fcfd"><meta name="description" content="Ship bundles based on the user's browser."><meta name="author" content="Sivasubramanyam A"><meta name="twitter:card" content="summary"><meta name="twitter:creator" content="@_51va"><meta property="og:url" content="https://siva.dev/ember-differential-bundles"><meta property="og:title" content="Differential Serving of Assets in Ember | Sivasubramanyam A"><meta property="og:description" content="Ship bundles based on the user's browser."><meta property="og:image" content="https://og.siva.dev/Differential%20Serving%20of%20Assets%20in%20Ember.png?desc=Ship%20bundles%20based%20on%20the%20user's%20browser.&link=ember-differential-bundles"><link rel="alternate" type="application/rss+xml" title="Sivasubramanyam A" href="https://siva.dev/rss.xml"><link rel="stylesheet" href="/static/css/styles.css"><noscript><style>.dark-mode-toggle-container{display:none!important}</style></noscript><link rel="stylesheet" href="/static/css/github-gist.css"><link rel="stylesheet" href="/static/css/ajanta.css"><noscript><style>.ajanta{display:none}</style></noscript><script inline src="/static/js/determine-webp-support.js"></script><script defer="defer" src="/static/js/intersection-lazy-loader.js"></script><script defer="defer" src="/static/js/instantpage.js"></script></head><body><nav class="nav-wrapper wrapper-screen animated"><div class="wrapper-xlarge nav"><ul class="list"><li class="item"><a class="link strong" href="/">Siva<span class="fullname">subramanyam A</span></a></li><li class="item"><a class="link skip-main" href="#main">Skip To Main Content</a></li></ul><ul class="list"><li class="item" aria-hidden="true"><p class="dark-mode-star">★</p></li><li class="item"><a class="link" href="/about/">About</a></li><li class="item"><a class="link" href="/notes/">Notes</a></li><li class="item"><a class="link" href="/blog/">Blog</a></li><li class="item"><a class="link" href="/art/">Art</a></li><li class="item dark-mode-toggle-container"><a class="link" role="button" tabindex="0" title="Toggle Dark Mode" id="dark-mode-toggle"><svg title="Toggle Dark Mode" class="icon icon-moon"><use xlink:href="#icon-moon"></use></svg><div class="magic"></div><svg title="Toggle Dark Mode" class="icon icon-sun"><use xlink:href="#icon-sun"></use></svg></a></li></ul></div></nav><div class="wrapper-screen animated"><header class="header header-post header-post-3"><h1 class="title">Differential Serving of Assets in Ember</h1><span class="date"><time datetime="01-03-2019">March 01, 2019</time> · <span class="reading-time" title="Estimated read time">5 min read</span></span><div class="post-tags">Tagged <a class="item" href="/tags/emberjs/">EmberJS</a></div></header></div><main id="main"><div class="wrapper-medium animated"><div class="post"><p><strong>Update</strong>: I recently spoke about this in <a href="https://chennaiemberjs.in/" target="_blank" rel="noopener">Chennai EmberJS</a>.</p><iframe width="100%" height="315" src="https://www.youtube.com/embed/lh9Rndz9g2o" srcdoc="<style>*{padding:0;margin:0;overflow:hidden}html,
                body{height:100%}img,span{position:absolute;width:100%;top:0;bottom:0;margin:auto}
                span{height:1.5em;text-align:center;font:48px/1.5 sans-serif;color:white;
                text-shadow:0 0 0.5em black}</style>
                <a href=https://www.youtube.com/embed/lh9Rndz9g2o?autoplay=1>
                <img src=https://img.youtube.com/vi/lh9Rndz9g2o/hqdefault.jpg alt='Differential bundling of assets in Ember'><span>▶</span></a>" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen rel="0" title="Differential bundling of assets in Ember"></iframe><br><br><p>The market share of users with evergreen browsers is rising fast. Inspite of this, we ship transpiled assets, often caused by the need to support legacy browsers like IE, to everyone. This is because dropping browser support isn't an easy affair, at least in enterprises. As a result, everyone, including those having the latest versions of browsers are forced to consume a bigger and slower bundle.</p><p>While there are established ways in React(through Webpack), Meteor and Vue to achieve differential bundling to serve assets based on the browser, there is currently no official way to do it in Ember. There is a <a href="https://github.com/emberjs/rfcs/issues/383" target="_blank" rel="noopener">pre-RFC</a> that is being discussed upon and I felt like writing out about a strategy that we have found to be feasible.</p><p>This strategy tries to address engines as well. With the usual <code>type=&quot;module&quot;</code> and <code>nomodule</code> approach, you cannot handle engines as they rely on the asset manifest provided by a <code>meta</code> tag with name as <code>app/config/asset-manifest</code>. There is no way to toggle <code>meta</code> tags in the frontend as of now and until Ember Engines support the <code>storeConfigInMeta</code> option, you will either have to do something similar to this solution or not do differential serving of engine assets. PS: There is a long-pending <a href="https://github.com/ember-engines/ember-engines/pull/228" target="_blank" rel="noopener">PR</a> to implement the <code>storeConfigInMeta</code> option in Ember Engines.</p><p>This solution requires you to serve different bundles by manipulating the HTML at runtime in the server based on a cookie, or if possible, parsing the UA.</p><h3><strong>Steps</strong></h3><ul><li>In your <code>index.html</code>, add <code>data-for=&quot;ember&quot;</code> attribute to script tags that are generated by Ember. For example,<pre class="hljs"><code><span class="xml">  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">data-for</span>=<span class="hljs-string">"ember"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"</span></span></span><span class="hljs-template-variable">{{rootURL}}</span><span class="xml"><span class="hljs-tag"><span class="hljs-string">assets/vendor.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">data-for</span>=<span class="hljs-string">"ember"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"</span></span></span><span class="hljs-template-variable">{{rootURL}}</span><span class="xml"><span class="hljs-tag"><span class="hljs-string">assets/app.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</span></code></pre></li><li>In your application code, run a small script to set a cookie to determine if the user is currently using a modern or legacy browser.<pre class="hljs"><code>  <span class="hljs-comment">// Serve modern build if Promise and async/await are present</span>
  <span class="hljs-keyword">let</span> testCode = <span class="hljs-string">'async() =&gt; { let p = new Promise(); await p(); }'</span>;
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// this needs to be a new Function/eval because otherwise,</span>
    <span class="hljs-comment">// you will get Syntax Errors in the code</span>
    (<span class="hljs-keyword">new</span> <span class="hljs-function"><span class="hljs-keyword">Function</span><span class="hljs-params">(testCode)</span>)<span class="hljs-params">()</span></span>;
    <span class="hljs-comment">// Set a never-expiring cookie</span>
  } <span class="hljs-keyword">catch</span>(err) {
    <span class="hljs-comment">// Set a cookie with a short validity(say a month)</span>
    <span class="hljs-comment">// If the user updates their browser, it will be reflected</span>
    <span class="hljs-comment">// once the cookie expires</span>
  }
</code></pre></li><li>In your <code>targets.js</code> file, use the <code>process.env.LEGACY</code> flag to toggle support for legacy browsers.<pre class="hljs"><code><span class="hljs-meta">  'use strict'</span>;

  <span class="hljs-keyword">let</span> browsers = [
    <span class="hljs-string">'last 1 Chrome versions'</span>,
    <span class="hljs-string">'last 1 Firefox versions'</span>,
    <span class="hljs-string">'last 1 Safari versions'</span>
  ];

  <span class="hljs-keyword">const</span> isCI = !!process.env.CI;
  <span class="hljs-keyword">const</span> isProduction = process.env.EMBER_ENV === <span class="hljs-string">'production'</span>;
  <span class="hljs-keyword">const</span> isLegacyBuild = !!process.env.LEGACY;

  <span class="hljs-keyword">if</span> (isCI || isProduction || isLegacyBuild) {
    browsers = [
      <span class="hljs-string">'Chrome &gt;= 42'</span>,
      <span class="hljs-string">'Firefox &gt;= 39'</span>,
      <span class="hljs-string">'Edge &gt;= 14'</span>,
      <span class="hljs-string">'Safari &gt;= 10'</span>
      <span class="hljs-string">'ie 11'</span>
    ];
  }

  <span class="hljs-built_in">module</span>.exports = { browsers };
</code></pre></li><li>Run parallel builds with<pre class="hljs"><code>  ember build <span class="hljs-attribute">--environment</span>=production <span class="hljs-attribute">--output-path</span>=modern &amp;&amp;
  <span class="hljs-attribute">LEGACY</span>=<span class="hljs-literal">true</span> ember build <span class="hljs-attribute">--environment</span>=production <span class="hljs-attribute">--output-path</span>=legacy
</code></pre><strong>Note:</strong> You can also run these builds in parallel. When doing so, you might often get build failures with the error <code>Unexpected end of file ...</code> due to an <a href="https://github.com/stefanpenner/broccoli-persistent-filter/issues/124" target="_blank" rel="noopener">issue</a> in broccoli-persistent-filter. To avoid this, set <code>process.env.BROCCOLI_PERSISTENT_FILTER_CACHE_ROOT</code> to a unique value for each build(for example, the complete path of the workspace or the current timestamp).</li><li>Run the <a href="https://github.com/astronomersiva/ember-differential-bundles/blob/master/index.js" target="_blank" rel="noopener"><code>index.js</code></a> provided in <a href="https://github.com/astronomersiva/ember-differential-bundles" target="_blank" rel="noopener">this repo</a>. It will generate a <code>dist</code> folder with an <code>index.html</code> containing combined script tags and meta tags wrapped in <code>&lt;MODERN&gt;</code> and <code>&lt;LEGACY&gt;</code> tags.</li><li>In your server, detect the presence of the cookie that was previously set (or use the UA) and replace the tags accordingly.<pre class="hljs"><code>  <span class="hljs-comment">// if modern browser</span>
  <span class="hljs-selector-tag">replaceAll</span>(<span class="hljs-string">'&lt;LEGACY&gt;.*&lt;/LEGACY&gt;'</span>, <span class="hljs-string">''</span>);
  <span class="hljs-selector-tag">replaceAll</span>(<span class="hljs-string">'&lt;MODERN&gt;(.*)&lt;/MODERN&gt;'</span>, <span class="hljs-string">'$1'</span>);
  <span class="hljs-comment">// if legacy browser</span>
  <span class="hljs-selector-tag">replaceAll</span>(<span class="hljs-string">'&lt;MODERN&gt;.*&lt;/MODERN&gt;'</span>, <span class="hljs-string">''</span>);
  <span class="hljs-selector-tag">replaceAll</span>(<span class="hljs-string">'&lt;LEGACY&gt;(.*)&lt;/LEGACY&gt;'</span>, <span class="hljs-string">'$1'</span>);
</code></pre></li></ul><p>Feel free to share your ideas or comments on this approach on <a href="https://github.com/astronomersiva/ember-differential-bundles/" target="_blank" rel="noopener">GitHub</a> or on Twitter.</p><div class="banner"></div></div></div></main><div class="wrapper-medium animated"><hr class="post-separator text-center"><div class="related"><h4>Here are a few similar posts that you might like:</h4><ul><li><a href="/adaptive-fetching/">Adaptive Loading Based on the User's Network</a></li><li><a href="/ember-2019/">#EmberJS2019, let's make things simple for developers</a></li><li><a href="/ember-pickr/">ember-pickr</a></li><li><a href="/render-performance-improvements/">Render the scene and not the universe</a></li><li><a href="/eagerly-prefetch-route-models-ember/">Eagerly Prefetching a Route's Model to Make Apps Faster</a></li><li><a href="/ember-line-graph/">ember-line-graph</a></li><li><a href="/emberjs-shipping-different-bundles/">Shipping EmberJS bundles based on the user's browser</a></li><li><a href="/ember-display-in-browser/">ember-display-in-browser</a></li></ul></div></div><footer class="footer animated" style=""><p class="m0">2014 - 2022 © <a target="_blank" href="/">Sivasubramanyam A</a></p><p>Crafted with <a class="link" target="_blank" rel="noopener" href="https://astronomersiva.github.io/lego">lego</a>, a custom built static site generator.</p><div class="social-links"><a class="link" title="Twitter" href="https://twitter.com/_51va" rel="noopener" target="_blank"><svg title="Twitter" class="icon icon-twitter"><use xlink:href="#icon-twitter"></use></svg> </a><a class="link" title="GitHub" href="https://github.com/astronomersiva" rel="noopener" target="_blank"><svg title="GitHub" class="icon icon-github"><use xlink:href="#icon-github"></use></svg> </a><a class="link" title="Email" href="mailto:hi@siva.dev" target="_blank"><svg title="email" class="icon icon-mail"><use xlink:href="#icon-mail"></use></svg> </a><a class="link" title="RSS Feed" href="https://siva.dev/rss.xml" target="_blank" rel="noopener"><svg class="icon icon-rss"><use xlink:href="#icon-rss"></use></svg></a></div></footer><svg display="none" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><symbol id="icon-rss" viewBox="0 0 1024 1024"><title>RSS Feed</title><path d="M122.88 122.88v121.19c362.803 0 656.896 294.195 656.896 656.998h121.293c0-429.773-348.416-778.189-778.189-778.189zM122.88 365.414v121.293c228.813 0 414.362 185.498 414.362 414.413h121.242c0-295.834-239.821-535.706-535.603-535.706zM239.053 668.621c-64.205 0-116.224 52.122-116.224 116.275s52.019 116.224 116.224 116.224 116.173-52.019 116.173-116.224-51.968-116.275-116.173-116.275z"></path></symbol><symbol id="icon-twitter" viewBox="0 0 1024 1024"><title>Twitter</title><path d="M886.579 319.795c0.41 8.294 0.563 16.691 0.563 24.986 0 255.488-194.406 549.99-549.888 549.99-109.21 0-210.739-32-296.294-86.886 15.155 1.792 30.515 2.714 46.080 2.714 90.624 0 173.926-30.925 240.026-82.688-84.531-1.587-155.955-57.395-180.531-134.195 11.776 2.202 23.91 3.379 36.352 3.379 17.664 0 34.765-2.304 50.944-6.707-88.422-17.818-155.034-95.898-155.034-189.594 0-0.819 0-1.587 0-2.406 26.061 14.49 55.91 23.194 87.552 24.218-51.866-34.714-86.016-93.798-86.016-160.922 0-35.379 9.523-68.608 26.214-97.178 95.283 116.992 237.773 193.894 398.387 201.984-3.277-14.182-4.966-28.877-4.966-44.083 0-106.701 86.477-193.178 193.229-193.178 55.603 0 105.83 23.398 141.107 60.979 43.981-8.704 85.35-24.781 122.726-46.899-14.438 45.107-45.107 82.995-84.992 106.906 39.117-4.71 76.288-15.002 111.002-30.413-25.907 38.81-58.675 72.806-96.461 99.994z"></path></symbol><symbol id="icon-github" viewBox="0 0 14 14"><title>GitHub</title><path fill-rule="evenodd" clip-rule="evenodd" d="M7 0C3.1325 0 0 3.21173 0 7.17706C0 10.3529 2.00375 13.0353 4.78625 13.9863C5.13625 14.0491 5.2675 13.8338 5.2675 13.6454C5.2675 13.4749 5.25875 12.9097 5.25875 12.3087C3.5 12.6406 3.045 11.8691 2.905 11.4653C2.82625 11.259 2.485 10.622 2.1875 10.4516C1.9425 10.317 1.5925 9.98508 2.17875 9.97611C2.73 9.96714 3.12375 10.4964 3.255 10.7118C3.885 11.7973 4.89125 11.4923 5.29375 11.3039C5.355 10.8374 5.53875 10.5234 5.74 10.3439C4.1825 10.1645 2.555 9.54549 2.555 6.80026C2.555 6.01976 2.82625 5.37382 3.2725 4.87143C3.2025 4.692 2.9575 3.95635 3.3425 2.96951C3.3425 2.96951 3.92875 2.78111 5.2675 3.70516C5.8275 3.54367 6.4225 3.46293 7.0175 3.46293C7.6125 3.46293 8.2075 3.54367 8.7675 3.70516C10.1063 2.77214 10.6925 2.96951 10.6925 2.96951C11.0775 3.95635 10.8325 4.692 10.7625 4.87143C11.2087 5.37382 11.48 6.01079 11.48 6.80026C11.48 9.55446 9.84375 10.1645 8.28625 10.3439C8.54 10.5682 8.75875 10.9988 8.75875 11.6717C8.75875 12.6316 8.75 13.4032 8.75 13.6454C8.75 13.8338 8.88125 14.0581 9.23125 13.9863C11.9963 13.0353 14 10.3439 14 7.17706C14 3.21173 10.8675 0 7 0Z"></path></symbol><symbol id="icon-mail" viewBox="0 0 1024 1024"><title>Email</title><path d="M80.589 270.643c24.986 13.414 371.098 199.373 384 206.285s29.594 10.189 46.387 10.189c16.794 0 33.485-3.277 46.387-10.189s359.014-192.87 384-206.285c25.037-13.466 48.691-65.843 2.765-65.843h-866.253c-45.926 0-22.272 52.378 2.714 65.843zM952.986 383.437c-28.416 14.797-378.214 197.069-395.622 206.182s-29.594 10.189-46.387 10.189-28.979-1.075-46.387-10.189-365.21-191.437-393.626-206.234c-19.968-10.445-19.763 1.792-19.763 11.213s0 373.402 0 373.402c0 21.504 28.979 51.2 51.2 51.2h819.2c22.221 0 51.2-29.696 51.2-51.2 0 0 0-363.93 0-373.35s0.205-21.658-19.814-11.213z"></path></symbol><symbol id="icon-moon" viewBox="-12 0 448 448.04455"><title>Toggle Dark Mode On</title><path d="m224.023438 448.03125c85.714843.902344 164.011718-48.488281 200.117187-126.230469-22.722656 9.914063-47.332031 14.769531-72.117187 14.230469-97.15625-.109375-175.890626-78.84375-176-176 .972656-65.71875 37.234374-125.832031 94.910156-157.351562-15.554688-1.980469-31.230469-2.867188-46.910156-2.648438-123.714844 0-224.0000005 100.289062-224.0000005 224 0 123.714844 100.2851565 224 224.0000005 224zm0 0"/></symbol><symbol id="icon-sun" viewBox="0 0 129 129"><title>Toggle Dark Mode Off</title><g><g><path d="m64.5,92.6c15.5,0 28-12.6 28-28s-12.6-28-28-28-28,12.6-28,28 12.5,28 28,28zm0-47.9c11,0 19.9,8.9 19.9,19.9 0,11-8.9,19.9-19.9,19.9s-19.9-8.9-19.9-19.9c0-11 8.9-19.9 19.9-19.9z"/><path d="m68.6,23.6v-12.9c0-2.3-1.8-4.1-4.1-4.1s-4.1,1.8-4.1,4.1v12.9c0,2.3 1.8,4.1 4.1,4.1s4.1-1.8 4.1-4.1z"/><path d="m60.4,105.6v12.9c0,2.3 1.8,4.1 4.1,4.1s4.1-1.8 4.1-4.1v-12.9c0-2.3-1.8-4.1-4.1-4.1s-4.1,1.8-4.1,4.1z"/><path d="m96.4,38.5l9.1-9.1c1.6-1.6 1.6-4.2 0-5.8-1.6-1.6-4.2-1.6-5.8,0l-9.1,9.1c-1.6,1.6-1.6,4.2 0,5.8 0.8,0.8 1.8,1.2 2.9,1.2s2.1-0.4 2.9-1.2z"/><path d="m23.5,105.6c0.8,0.8 1.8,1.2 2.9,1.2 1,0 2.1-0.4 2.9-1.2l9.1-9.1c1.6-1.6 1.6-4.2 0-5.8-1.6-1.6-4.2-1.6-5.8,0l-9.1,9.1c-1.6,1.6-1.6,4.2 0,5.8z"/><path d="m122.5,64.6c0-2.3-1.8-4.1-4.1-4.1h-12.9c-2.3,0-4.1,1.8-4.1,4.1 0,2.3 1.8,4.1 4.1,4.1h12.9c2.2,1.42109e-14 4.1-1.8 4.1-4.1z"/><path d="m10.6,68.7h12.9c2.3,0 4.1-1.8 4.1-4.1 0-2.3-1.8-4.1-4.1-4.1h-12.9c-2.3,0-4.1,1.8-4.1,4.1 0,2.3 1.9,4.1 4.1,4.1z"/><path d="m102.6,106.8c1,0 2.1-0.4 2.9-1.2 1.6-1.6 1.6-4.2 0-5.8l-9.1-9.1c-1.6-1.6-4.2-1.6-5.8,0-1.6,1.6-1.6,4.2 0,5.8l9.1,9.1c0.8,0.8 1.9,1.2 2.9,1.2z"/><path d="m38.4,38.5c1.6-1.6 1.6-4.2 0-5.8l-9.1-9.1c-1.6-1.6-4.2-1.6-5.8,0-1.6,1.6-1.6,4.2 0,5.8l9.1,9.1c0.8,0.8 1.8,1.2 2.9,1.2s2.1-0.4 2.9-1.2z"/></g></g></symbol><symbol id="icon-link" viewBox="0 0 24 24"><title>Link</title><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></symbol><symbol id="icon-plus" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/></symbol></defs></svg><script defer="defer" inline src="/static/js/ajanta-without-blur.js"></script></body></html>