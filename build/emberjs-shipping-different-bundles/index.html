<!DOCTYPE html>
<html lang="en">
<head>
  <title>@siva | Shipping EmberJS bundles based on the user&#39;s browser</title>
  <meta property="og:title" content="Shipping EmberJS bundles based on the user&#39;s browser" />
  <meta property="og:site_name" content="@siva" />
  <meta property="og:url" content="https://sivasubramanyam.me/emberjs-shipping-different-bundles" />
  <meta property="og:description" content="A way to stop sending transpiled code to evergreen browsers with EmberJS" />
  <meta name="description" content="A way to stop sending transpiled code to evergreen browsers with EmberJS" />
  <meta charset="utf-8">
<meta content="IE=edge" http-equiv="X-UA-Compatible">
<link rel="apple-touch-icon" sizes="57x57" href="/static/favicons/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/static/favicons/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/static/favicons/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/static/favicons/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/static/favicons/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/static/favicons/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/static/favicons/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/static/favicons/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/static/favicons/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192"  href="/static/favicons/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="/static/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/static/favicons/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="/static/favicons/favicon-16x16.png">
<meta name="msapplication-TileImage" content="/static/favicons/ms-icon-144x144.png">
<meta name="keywords" content="sivasubramanyam,sivasubramanyam.me">
<meta name="author" content="Sivasubramanyam A">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>@siva </title>

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-57141163-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-57141163-3');
</script>

<script>
  isWebp = () => document.createElement('canvas').toDataURL('image/webp').startsWith('data:image/webp');
  if (isWebp()) {
    let html = document.getElementsByTagName('html')[0];
    html.className = 'webp';
  }
</script>

<link type="text/css" rel="stylesheet" href="/static/sdist/e6de4230db40b08a038970deb7b7c004.css">
  
</head>
<body>
  <div class="container-fluid">
    <div class="row content hero hero-post">
      <div class="navbr navbr-primary">
  <a href="/">@siva</a>
</div>

<div class="navbr navbr-secondary">
  
    Tagged
    
      &nbsp;&nbsp;-<a href = "/tag/EmberJS">&nbsp;&nbsp;EmberJS</a>
    
      &nbsp;&nbsp;-<a href = "/tag/Build">&nbsp;&nbsp; Build</a>
    
  
</div>
      <div class="col-md-8 col-md-offset-2 helloWorld">
        <div class="hello hello-post">
          Shipping EmberJS bundles based on the user&#39;s browser
        </div>
      </div>
    </div>
  </div>

  <main role="main">
    <div class="container posts">
      <div class="row">
        <div class="col-md-8 col-md-offset-2 content">
          
  <p>EmberJS provided <a href="https://rwjblue.com/2017/04/21/ember-cli-targets/">a way to specify browser targets</a> in April, 2017. With this, one could specify a list of browsers based on the app consumers' analytics and ship properly transpiled code.</p>
<p>When this came out, a few people in the Ember Community(including me) <a href="https://github.com/babel/ember-cli-babel/issues/200">started looking</a> for ways to define multiple targets for the same build. With the current setup of using <code>@babel/preset-env</code>, we were shipping code needed for IE11 to users with Chrome and Firefox even though IE11 users were a considerable minority. Not only were we shipping unnecessary code, we were slowing down their experience in terms of JS parse and compile times. After numerous conversations on Twitter, Slack and Github issues, it became clear that it was not currently possible. I eventually forgot about this.</p>
<p>The call for blog posts for #EmberJS2018 was out and I <a href="https://twitter.com/astronomersiva/status/1002280628815982592">tweeted</a> about this in <a href="https://twitter.com/astronomersiva/status/996041686311583744">one</a> of my replies. After reading Stefan Penner's replies, it became clear that a very obvious solution was to simple generate multiple builds with different build targets and make use of some logic at the server to determine which bundle to ship to the user.</p>
<p>We use <a href="http://ember-cli-deploy.com/docs/v0.6.x/the-lightning-strategy/">ember-cli-deploy</a> and the amazing <a href="http://ember-cli-deploy.com/docs/v0.6.x/the-lightning-strategy/">Lightning Strategy</a> to ship our assets. Please watch this amazing talk by Luke Melia if you haven't heard of this before.</p>
<iframe width="100%" height="315" src="https://www.youtube-nocookie.com/embed/QZVYP3cPcWQ" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>

<p>One of the core concepts of this strategy is to have a build label(say, June_1_2018) pointing to the <code>index.html</code> of the build. <code>ember-cli-deploy</code> provides various hooks to take control of your entire build pipeline. Using those hooks, generate and upload two different builds for your application. You can make use of ENV variables to change the targets. So, generate one build with transpilation and another without transpilation. One of these builds works for all browsers specified in the <code>targets.js</code> and the other will work only on modern browsers.</p>
<p><img data-src="/static/images/targets.png" src="" alt="Passing ENV to targets"></p>
<p>With the lightning approach, each of these builds will have a different build label(say, June_1_2018_1 for transpiled and June_1_2018_2 for untranspiled). With ember-cli-deploy, we can change these! We can change the label of the untranspiled build to <code>${label_of_transpiled_build}-modern</code>.</p>
<p>Now, once the app loads, you can test for ES6 support by <a href="https://www.bram.us/2016/10/31/checking-if-a-browser-supports-es6/">this technique</a> and set a cookie or use the User-Agent to determine which build is needed. On subsequent reloads, check for the existence of this cookie and if the user's browser supports ES6, all you have to do is send the index.html pointed by the <code>${latest_build_label}_modern</code>.</p>
<p>I used this approach and saw a reduction of around 250kb before gzip and 60kb after gzip in the shipped bundle size for modern browsers. The parse and compile times were reduced and page load time came down by around 5-7 seconds on slower computers!</p>
<p>Feel free to try this approach and share your performance gains, alternate ideas and criticism!</p>

        </div>
      </div>
    </div>
  </main>

  <footer>
  <div class="row footer-contents">
    <div class="col-md-offset-6 col-md-6 copyright">
        2018 &copy; Sivasubramanyam A 
        <a href="http://twitter.com/astronomersiva" class="social" aria-label="twitter">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 612 612"><path d="M612 116.258a250.714 250.714 0 0 1-72.088 19.772c25.929-15.527 45.777-40.155 55.184-69.411-24.322 14.379-51.169 24.82-79.775 30.48-22.907-24.437-55.49-39.658-91.63-39.658-69.334 0-125.551 56.217-125.551 125.513 0 9.828 1.109 19.427 3.251 28.606-104.326-5.24-196.835-55.223-258.75-131.174-10.823 18.51-16.98 40.078-16.98 63.101 0 43.559 22.181 81.993 55.835 104.479a125.556 125.556 0 0 1-56.867-15.756v1.568c0 60.806 43.291 111.554 100.693 123.104-10.517 2.83-21.607 4.398-33.08 4.398-8.107 0-15.947-.803-23.634-2.333 15.985 49.907 62.336 86.199 117.253 87.194-42.947 33.654-97.099 53.655-155.916 53.655-10.134 0-20.116-.612-29.944-1.721 55.567 35.681 121.536 56.485 192.438 56.485 230.948 0 357.188-191.291 357.188-357.188l-.421-16.253c24.666-17.593 46.005-39.697 62.794-64.861z"/></svg>
        </a>
         / 
        <a href="http://github.com/astronomersiva" class="social" aria-label="github">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
        </a>
    </div>
  </div>
</footer>

<style>
  @font-face {
    font-family: 'Source Sans Pro';
    font-style: normal;
    font-weight: 400;
    font-display: swap;
    src: local('Source Sans Pro Regular'), local('SourceSansPro-Regular'), url(https://fonts.gstatic.com/s/sourcesanspro/v11/ODelI1aHBYDBqgeIAH2zlJbPFduIYtoLzwST68uhz_Y.woff2) format('woff2');
    unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2212, U+2215;
  }
</style>

<script defer>
  let images = document.getElementsByTagName('img');
  for(let image of images) {
    image.className = `${image.className} img-responsive center-block`;
  }
</script>

  

  <script>
    let imagesToLazyLoad = document.getElementsByTagName('img');
    for (let image of imagesToLazyLoad) {
      image.src = image.getAttribute('data-src');
    }
  </script>
</body>
</html>